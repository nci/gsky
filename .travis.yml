language: go
go: 1.9.x
env:
  - PREFIX=$HOME/local
services:
  - postgresql
addons:
  postgresql: "9.6"
  apt:
    packages:
    - postgresql-9.6-postgis-2.3
    - libproj-dev
    - libhdf4-dev
    - libhdf5-dev
    - libnetcdf-dev
    - libopenjpeg-dev
    - openjpeg-tools

before_script:
  - psql -U postgres -c "create extension postgis"

install:
  - git clone https://github.com/sstephenson/bats.git
  - (cd bats && ./install.sh $PREFIX)
  - wget http://download.osgeo.org/gdal/2.2.4/gdal-2.2.4.tar.gz
  - wget http://download.osgeo.org/gdal/2.2.4/gdal-2.2.4.tar.gz.md5
  - md5sum gdal-2.2.4.tar.gz | cmp - gdal-2.2.4.tar.gz.md5
  - tar xfvz gdal-2.2.4.tar.gz
  - (cd gdal-2.2.4 && ./configure --with-openjpeg --prefix=$HOME/gdal-install && make -s all install)

script:
  - cd $TRAVIS_BUILD_DIR/mas/db && psql -f schema.sql -U postgres
  - go tool vet $TRAVIS_BUILD_DIR
  # Ensure that gofmt -d produces zero diff output
  - test -z "$(gofmt -d $TRAVIS_BUILD_DIR)"

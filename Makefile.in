prefix = @prefix@
exec_prefix = @exec_prefix@
datarootdir = @datarootdir@
sbindir = @sbindir@
libexecdir = @libexecdir@
sysconfdir = @sysconfdir@
srcdir = @srcdir@
VPATH = @srcdir@

CGO_CFLAGS="@CGO_CFLAGS@"
CGO_LDFLAGS="@CGO_LDFLAGS@"
LDFLAGS="-X=_$(srcdir)/utils.LibexecDir=${libexecdir} -X=_$(srcdir)/grpc_server/gdalservice.LibexecDir=${libexecdir} \
	-X=_$(srcdir)/utils.EtcDir=$(sysconfdir) -X=_$(srcdir)/utils.DataDir=${datarootdir}/gsky"
GOBUILD = CGO_CFLAGS=$(CGO_CFLAGS) CGO_LDFLAGS=$(CGO_LDFLAGS) go build -ldflags=$(LDFLAGS)

all: concurrent
	go get
	$(GOBUILD) -o gsky-rpc grpc_server/grpc_server.go
	$(GOBUILD) -o gsky-gdal-process grpc_server/gdal_process.go
	$(GOBUILD) -o gsky-ows ows.go
	$(GOBUILD) -o gsky-crawl crawl/crawl.go
	$(GOBUILD) -o accept acceptance_tests/accept.go
	$(GOBUILD) -o masapi mas/api/api.go

concurrent: src/concurrent.c
	$(CC) -Wall -O2 $< -o $@

src/concurrent.c:
	mkdir -p $(dir $@)
	wget --quiet https://github.com/seanpringle/concurrent/raw/634330a119f16916e5ad24da32172fa9312ab5a3/concurrent.c -O $@

# Note: install(1) can't deal with directories as source, so use cp -r.
install:
	install -d $(sbindir) $(libexecdir) $(sysconfdir)
	install -d $(datarootdir)/gsky/templates
	install -d $(datarootdir)/gsky/static
	install -d $(datarootdir)/mas
	install concurrent $(sbindir)
	install gsky-ows $(sbindir)
	install gsky-gdal-process $(libexecdir)
	install gsky-rpc $(sbindir)
	install gsky-crawl $(sbindir)
	install masapi $(sbindir)
	install -m 644 $(srcdir)/zoom.png $(sysconfdir)
	install -m 644 $(srcdir)/data_unavailable.png $(sysconfdir)
	for f in $(srcdir)/templates/* ; do install -m 644 $$f $(datarootdir)/gsky/templates ; done
	cp -rp $(srcdir)/static/* $(datarootdir)/gsky/static
	for f in $(srcdir)/mas/db/*.sql ; do install -m 644 $$f $(datarootdir)/mas ; done
	for f in $(srcdir)/mas/db/*.sh ; do install -m 755 $$f $(datarootdir)/mas ; done

clean:
	-rm -f accept gsky-crawl gsky-gdal-process gsky-ows gsky-rpc masapi concurrent
